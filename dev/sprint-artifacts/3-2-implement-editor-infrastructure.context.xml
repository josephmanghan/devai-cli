<story-context id="{bmad_folder}/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>3</epicId>
    <storyId>2</storyId>
    <title>Implement Editor Infrastructure</title>
    <status>drafted</status>
    <generatedAt>2025-12-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>dev/sprint-artifacts/3-2-implement-editor-infrastructure.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer using ollatool</asA>
    <iWant>to edit generated commit messages in my preferred terminal editor</iWant>
    <soThat>I can customize commit messages before finalizing them</soThat>
    <tasks>- Task 1: Create EditorPort interface (AC: 1)
  - Subtask 1.1: Define interface with edit(initialContent) method
  - Subtask 1.2: Add comprehensive JSDoc for public interface
- Task 2: Implement ShellEditorAdapter (AC: 2,3,4,5,6)
  - Subtask 2.1: Implement editor detection logic ($EDITOR vs fallback)
  - Subtask 2.2: Implement temporary file creation in .git/ directory
  - Subtask 2.3: Implement editor spawning with stdio: 'inherit' for terminal control
  - Subtask 2.4: Implement content reading and cleanup after editor closes
  - Subtask 2.5: Add error handling for editor crashes/cancellation
- Task 3: Create comprehensive unit tests (AC: 7)
  - Subtask 3.1: Mock spawn/ChildProcess with vi.mock
  - Subtask 3.2: Test editor detection and fallback logic
  - Subtask 3.3: Test temporary file creation and cleanup
  - Subtask 3.4: Test content reading and error scenarios
- Task 4: Code quality validation (AC: 8,9)
  - Subtask 4.1: Run npm run format and npm run lint
  - Subtask 4.2: Run npm run pr to validate complete quality gate</tasks>
  </story>

  <acceptanceCriteria>1. EditorPort interface defined with method: edit(initialContent) that opens user's $EDITOR
2. ShellEditorAdapter implements EditorPort using Node.js spawn with stdio: 'inherit'
3. Editor adapter respects $EDITOR environment variable with fallback to 'nano'
4. Creates temporary file in .git/ directory for editor content
5. Reads edited content back after editor closes
6. Handles editor cancellation gracefully and cleans up temporary files
7. Unit tests with proper mocking of spawn/ChildProcess (100% coverage for adapter)
8. Code follows clean code standards (no JSDoc on private methods, functions <15 lines)
9. npm run pr passes with zero warnings</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="dev/sprint-artifacts/tech-spec-epic-3.md" title="Epic Technical Specification: Git & Editor Infrastructure" section="EditorPort Interface" snippet="EditorPort Interface with method: openEditor(initialContent: string): Promise<string>. Must open system editor with the given initial content and return the text content after the user saves and quits." />
      <doc path="dev/sprint-artifacts/tech-spec-epic-3.md" title="Epic Technical Specification: Git & Editor Infrastructure" section="ShellEditorAdapter Implementation" snippet="Implements EditorPort using spawn with stdio: 'inherit'. Respects $EDITOR environment variable (defaults to 'nano'). Uses temporary file pattern (.git/COMMIT_EDITMSG_OLLATOOL)." />
      <doc path="dev/stories/epic-3-git-context.md" title="Epic 3: Git & Editor Infrastructure" section="Story 3.2 Technical Notes" snippet="Flow: Write initialContent to temp file, spawn editor process (must block until exit), read file content back. Crucial: Always delete temp file in finally block." />
      <doc path="dev/architecture.md" title="Project Architecture Document" section="Editor Integration Strategy" snippet="Temp file & spawn pattern: .git/COMMIT_EDITMSG_OLLATOOL + $EDITOR. Use execa to spawn $EDITOR (default: nano). Critical: Must use { stdio: 'inherit' } to let editor take over terminal input/output." />
      <doc path="dev/architecture.md" title="Project Architecture Document" section="Project Structure (Hexagonal)" snippet="Infrastructure Layer: src/infrastructure/editor/shell-editor-adapter.ts. Terminal editor integration ($EDITOR)." />
      <doc path="dev/architecture.md" title="Project Architecture Document" section="Error Handling Strategy" snippet="Use custom error classes: UserError for editor crashes/cancellation (Exit 2). SystemError for spawn failures (Exit 3)." />
      <doc path="dev/architecture.md" title="Project Architecture Document" section="Testing Patterns" snippet="Co-located tests, mock via Vitest utilities. Mock fs/promises and child_process.spawn for ShellEditorAdapter." />
    </docs>
    <code>
      <codeRef path="src/core/ports/git-port.ts" kind="interface" symbol="GitPort" lines="5-40" reason="Reference pattern for port interface design and JSDoc documentation" />
      <codeRef path="src/infrastructure/adapters/shell-git-adapter.ts" kind="adapter" symbol="ShellGitAdapter" lines="10-15" reason="Implementation pattern: Constructor with dependency injection using readonly property" />
      <codeRef path="src/infrastructure/adapters/shell-git-adapter.ts" kind="adapter" symbol="ShellGitAdapter" lines="112-138" reason="Error mapping pattern: wrapGitError method showing UserError vs SystemError distinction" />
      <codeRef path="src/infrastructure/adapters/shell-git-adapter.ts" kind="adapter" symbol="ShellGitAdapter" lines="145-202" reason="Error detection pattern: Private methods for specific error identification" />
      <codeRef path="src/infrastructure/adapters/shell-git-adapter.test.ts" kind="test" symbol="mock" lines="7-11" reason="Testing pattern: vi.mock for external library mocking (apply to spawn)" />
      <codeRef path="src/infrastructure/adapters/shell-git-adapter.test.ts" kind="test" symbol="test-structure" lines="13-24" reason="Testing pattern: beforeEach/afterEach setup with mock management" />
      <codeRef path="src/core/types/errors.types.ts" kind="types" symbol="UserError" lines="77-83" reason="Error type for editor crashes/cancellation (Exit 2)" />
      <codeRef path="src/core/types/errors.types.ts" kind="types" symbol="SystemError" lines="85-91" reason="Error type for spawn failures (Exit 3)" />
    </code>
    <dependencies>
      <dependency ecosystem="nodejs" name="execa" version="^9.6.1" purpose="Shell command execution (used in GitAdapter pattern)" />
      <dependency ecosystem="nodejs" name="vitest" version="^4.0.14" purpose="Testing framework with vi.mock for spawn/ChildProcess mocking" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">Must follow Hexagonal Architecture: Core layer defines interface (EditorPort), Infrastructure layer implements adapter (ShellEditorAdapter)</constraint>
    <constraint type="file-location">EditorPort interface must be in src/core/ports/editor-port.ts</constraint>
    <constraint type="file-location">ShellEditorAdapter must be in src/infrastructure/adapters/shell-editor-adapter.ts</constraint>
    <constraint type="implementation">Must use Node.js spawn with stdio: 'inherit' for terminal control transfer</constraint>
    <constraint type="implementation">Must create temporary files in .git/ directory using pattern .git/COMMIT_EDITMSG_OLLATOOL</constraint>
    <constraint type="implementation">Must respect $EDITOR environment variable with fallback to 'nano'</constraint>
    <constraint type="error-handling">Must use UserError (Exit 2) for editor crashes/cancellation, SystemError (Exit 3) for spawn failures</constraint>
    <constraint type="cleanup">Must always delete temporary files in finally blocks to prevent file debris</constraint>
    <constraint type="testing">Must create co-located test file with vi.mock for spawn/ChildProcess</constraint>
    <constraint type="quality">Functions must be &lt;15 lines, no JSDoc on private methods, use npm run pr for validation</constraint>
    <constraint type="patterns">Follow established patterns from GitPort â†’ ShellGitAdapter for consistency</constraint>
  </constraints>
  <interfaces>
    <interface name="EditorPort" kind="class interface" signature="edit(initialContent: string): Promise<string>" path="src/core/ports/editor-port.ts" />
  </interfaces>
  <tests>
    <standards>Co-located tests with implementation files using Vitest. Use vi.mock for external library mocking (spawn, fs/promises). Follow established patterns from ShellGitAdapter tests: beforeEach/afterEach setup, comprehensive error scenario coverage, interface compliance validation. Functions must be &lt;15 lines. 100% coverage for adapter logic. No console noise in test output.</standards>
    <locations>src/infrastructure/adapters/shell-editor-adapter.test.ts (co-located with implementation)</locations>
    <ideas>
      <testIdea for="AC-1" description="Test EditorPort interface compilation and method signature validation">Verify interface compiles and defines required edit method signature</testIdea>
      <testIdea for="AC-2,3" description="Test editor detection and fallback logic">Mock process.env.EDITOR to test environment variable detection and fallback to 'nano'</testIdea>
      <testIdea for="AC-4,5,6" description="Test temp file creation/editor spawning/content reading/cleanup">Mock fs/promises and spawn to verify complete workflow and cleanup in finally block</testIdea>
      <testIdea for="AC-6" description="Test error handling for editor crashes/cancellation">Mock spawn failure with non-zero exit code, verify UserError thrown and cleanup still happens</testIdea>
      <testIdea for="AC-2" description="Test spawn arguments validation">Verify spawn called with correct editor command and stdio: 'inherit' option</testIdea>
      <testIdea for="AC-7" description="Test interface compliance">Verify ShellEditorAdapter implements EditorPort correctly</testIdea>
    </ideas>
  </tests>
</story-context>