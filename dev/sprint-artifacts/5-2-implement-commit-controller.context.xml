<story-context id=".bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>5</epicId>
    <storyId>2</storyId>
    <title>Implement Commit Controller</title>
    <status>drafted</status>
    <generatedAt>2025-12-02</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>dev/sprint-artifacts/5-2-implement-commit-controller.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>a developer using ollatool,</asA>
    <iWant>a commit controller that orchestrates the entire commit workflow from validation through commit execution,</iWant>
    <sothat>I can generate and commit messages seamlessly through a single command.</soThat>
    <tasks>- [ ] Task 1: Create Commit Controller Class Structure (AC: 1, 5, 8)
  - [ ] Subtask 1.1: Create `src/features/commit/controllers/commit-controller.ts`
  - [ ] Subtask 1.2: Implement constructor with dependency injection for ValidatePreconditions, GenerateCommit, GitService, EditorService
  - [ ] Subtask 1.3: Add TypeScript interfaces for controller inputs/outputs
  - [ ] Subtask 1.4: Follow clean code member ordering and keep methods ≤15 lines
- [ ] Task 2: Implement Core Workflow Orchestration (AC: 2)
  - [ ] Subtask 2.1: Implement main execute() method with complete workflow sequence
  - [ ] Subtask 2.2: Add precondition validation step using ValidatePreconditions use case
  - [ ] Subtask 2.3: Integrate TypeSelector component for commit type selection
  - [ ] Subtask 2.4: Integrate GenerateCommit use case for message generation
  - [ ] Subtask 2.5: Integrate MessagePreview component for user review
  - [ ] Subtask 2.6: Integrate ActionSelector component for user action selection
  - [ ] Subtask 2.7: Handle commit execution and editor workflow based on user action
- [ ] Task 3: Implement Error Handling Integration (AC: 3, 6)
  - [ ] Subtask 3.1: Add try-catch blocks with proper error categorization
  - [ ] Subtask 3.2: Handle UserError with specific remediation guidance
  - [ ] Subtask 3.3: Handle SystemError with actionable error messages
  - [ ] Subtask 3.4: Handle ValidationError with retry/regenerate options
  - [ ] Subtask 3.5: Add cancel handling for all interactive prompts
- [ ] Task 4: Integrate UI Components (AC: 4)
  - [ ] Subtask 4.1: Import and use TypeSelector from `@/ui/commit/components/type-selector`
  - [ ] Subtask 4.2: Import and use MessagePreview from `@/ui/commit/components/message-preview`
  - [ ] Subtask 4.3: Import and use ActionSelector from `@/ui/commit/components/action-selector`
  - [ ] Subtask 4.4: Handle component-specific error cases (isCancel scenarios)
- [ ] Task 5: Create Comprehensive Unit Tests (AC: 7)
  - [ ] Subtask 5.1: Create `src/features/commit/controllers/commit-controller.test.ts`
  - [ ] Subtask 5.2: Mock all dependencies using Vitest vi.fn() methods
  - [ ] Subtask 5.3: Test successful complete workflow path
  - [ ] Subtask 5.4: Test error scenarios for each error type
  - [ ] Subtask 5.5: Test cancel scenarios at each interaction point
  - [ ] Subtask 5.6: Test editor workflow integration
  - [ ] Subtask 5.7: Achieve ≥80% test coverage
- [ ] Task 6: Code Quality and Documentation (AC: 8)
  - [ ] Subtask 6.1: Ensure all methods ≤15 lines, extract private helpers
  - [ ] Subtask 6.2: Follow class member ordering standards
  - [ ] Subtask 6.3: Add self-documenting code with no "why" comments
  - [ ] Subtask 6.4: Verify imports use barrel exports from index files, matching patterns from existing</tasks>
  </story>

  <acceptanceCriteria>1. **Commit Controller Class** - Main orchestrator with dependency injection for all required components (ValidatePreconditions, GenerateCommit, GitService, EditorService).
2. **Complete Workflow Loop** - Implement full interaction sequence: Validate → Type Selection → Generate → Preview → Action → Commit.
3. **Error Handling Integration** - Proper handling of UserError, SystemError, ValidationError with actionable remediation messages.
4. **UI Components Integration** - Use existing TypeSelector, MessagePreview, ActionSelector components from Story 5.1.
5. **Dependency Injection** - Constructor injection following clean architecture patterns with proper interface usage.
6. **Cancel Handling** - Graceful handling of Ctrl+C at any interaction point with clean process exit.
7. **Unit Tests** - Comprehensive tests with ≥80% coverage for all workflow paths including error scenarios.
8. **Clean Code Standards** - Methods ≤15 lines, proper class member ordering (constructor → private → public → private), self-documenting code.</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc path="dev/architecture.md" title="Architecture Document" section="Use Case Pattern" snippet="Use Case Pattern: Controller orchestrates multiple use cases and services with constructor injection for testability and clean architecture." />
      <doc path="dev/architecture.md" title="Architecture Document" section="Dependency Injection Pattern" snippet="Dependency Injection: Constructor injection for testability and clean architecture with proper interface usage." />
      <doc path="dev/architecture.md" title="Architecture Document" section="Error Class Hierarchy" snippet="Error Handling: Use typed error classes with proper remediation - UserError, SystemError, ValidationError." />
      <doc path="dev/ux-design-specification.md" title="UX Design Specification" section="Interactive Selection System" snippet="UI Component Integration: Stateless components using @clack/prompts with proper cancel handling and process exit." />
      <doc path="dev/epics.md" title="Epics Document" section="Epic 5 - Interactive Workflow & CLI" snippet="Epic 5 focuses on interactive workflow components including TypeSelector, MessagePreview, ActionSelector using @clack/prompts." />
      <doc path="dev/sprint-artifacts/tech-spec-epic-5.md" title="Tech Spec Epic 5" section="Application Layer" snippet="CommitController is the main State Machine & Orchestrator coordinating GitPort, EditorPort, and GenerateCommit use case." />
    </docs>
    <code>
      <code path="src/ui/commit/components/type-selector/type-selector.ts" kind="ui-component" symbol="selectCommitType" lines="13-32" reason="Available UI component for commit type selection using @clack/prompts with proper cancel handling" />
      <code path="src/ui/commit/components/action-selector/action-selector.ts" kind="ui-component" symbol="selectCommitAction" lines="32-45" reason="Available UI component for action selection (Approve/Edit/Regenerate/Cancel)" />
      <code path="src/ui/commit/components/message-preview/message-preview.ts" kind="ui-component" symbol="previewMessage" lines="7-16" reason="Available UI component for displaying commit message preview" />
      <code path="src/features/commit/use-cases/validate-preconditions.ts" kind="use-case" symbol="ValidatePreconditions" lines="13-35" reason="Existing use case for precondition validation with dependency injection pattern" />
      <code path="src/features/commit/use-cases/generate-commit.ts" kind="use-case" symbol="GenerateCommit" lines="14-27" reason="Existing use case for AI commit generation with retry logic and validation" />
      <code path="src/core/types/errors.types.ts" kind="types" symbol="UserError, SystemError, ValidationError" lines="77-99" reason="Error classes to use for proper error handling with exit codes 2, 3, 4" />
      <code path="src/core/types/commit.types.ts" kind="types" symbol="CommitAction, CommitType, COMMIT_TYPES" lines="6-53" reason="Core enums and types for commit functionality" />
      <code path="src/core/ports/git-port.ts" kind="port" symbol="GitPort" lines="5-41" reason="Interface for Git operations - commitChanges method available for final commit execution" />
      <code path="src/core/ports/editor-port.ts" kind="port" symbol="EditorPort" lines="6-19" reason="Interface for editor integration when user selects Edit action" />
    </code>
    <dependencies>
      <package ecosystem="node" name="@clack/prompts" version="^0.11.0" reason="Interactive TUI components (select, note, cancel) with modern terminal UX" />
      <package ecosystem="node" name="commander" version="14.0.2" reason="CLI framework for command structure and argument parsing" />
      <package ecosystem="node" name="execa" version="^9.6.1" reason="Process execution for shell commands (git, editor)" />
      <package ecosystem="node" name="ollama" version="^0.6.3" reason="Ollama client for AI model communication" />
      <package ecosystem="node" name="ora" version="^9.0.0" reason="Terminal spinners for async operations" />
      <package ecosystem="node" name="debug" version="^4.4.3" reason="Debug logging with configurable output levels" />
      <dev-package ecosystem="node" name="vitest" version="^4.0.14" reason="Testing framework with mocking and coverage support" />
      <dev-package ecosystem="node" name="tsx" version="latest" reason="TypeScript execution for development and scripts" />
      <dev-package ecosystem="node" name="tsup" version="latest" reason="TypeScript bundling and build optimization" />
    </dependencies>
  </artifacts>

  <constraints>
    <constraint severity="high">Must implement pragmatic hexagonal architecture with manual dependency injection - no IoC containers</constraint>
    <constraint severity="high">Controller methods must be ≤15 lines with constructor → private properties → public methods → private methods ordering</constraint>
    <constraint severity="high">Must use barrel exports from index files for clean imports and dependency management</constraint>
    <constraint severity="medium">Components must be pure functions using @clack/prompts 0.11.0 with proper cancel handling</constraint>
    <constraint severity="medium">All interactive prompts must handle Ctrl+C gracefully with isCancel checks and process.exit(0)</constraint>
    <constraint severity="medium">Error handling must use typed error classes (UserError, SystemError, ValidationError) with remediation guidance</constraint>
    <constraint severity="low">Follow existing naming patterns: kebab-case files, PascalCase classes, camelCase functions</constraint>
  </constraints>
  <interfaces>
    <interface name="ValidatePreconditions" source="src/features/commit/use-cases/validate-preconditions.ts" reason="Use case for validating daemon connection, git repository, and staged changes" signature="constructor(gitPort: GitPort, llmPort: LlmPort); execute(): Promise&lt;CommitContext&gt;" />
    <interface name="GenerateCommit" source="src/features/commit/use-cases/generate-commit.ts" reason="Use case for AI commit generation with retry logic" signature="constructor(llmProvider: LlmPort); execute(input: GenerateCommitInput): Promise&lt;string&gt;" />
    <interface name="GitPort" source="src/core/ports/git-port.ts" reason="Git operations interface for repository checks and commit execution" signature="getStagedDiff(): Promise&lt;string&gt;; getBranchName(): Promise&lt;string&gt;; commitChanges(message: string): Promise&lt;void&gt;" />
    <interface name="EditorPort" source="src/core/ports/editor-port.ts" reason="Editor integration interface for user edit workflow" signature="edit(initialContent: string): Promise&lt;string&gt;" />
    <interface name="selectCommitType" source="src/ui/commit/components/type-selector/type-selector.ts" reason="UI component for commit type selection" signature="(): Promise&lt;CommitType&gt;" />
    <interface name="selectCommitAction" source="src/ui/commit/components/action-selector/action-selector.ts" reason="UI component for action selection" signature="(): Promise&lt;CommitAction&gt;" />
    <interface name="previewMessage" source="src/ui/commit/components/message-preview/message-preview.ts" reason="UI component for message preview" signature="(message: string): Promise&lt;void&gt;" />
  </interfaces>
  <tests>
    <standards>Co-located unit tests with Vitest framework. Mock all dependencies using vi.fn() methods. Test all paths including success, error scenarios, and cancel handling. Target ≥80% test coverage for controller logic. Test file follows same directory with .test.ts extension.</standards>
    <locations>src/features/commit/controllers/commit-controller.test.ts - co-located test file for controller. Test pattern: mock dependencies, test each workflow path, verify error handling and cancel scenarios.</locations>
    <ideas ac="1,5,8">Test constructor dependency injection with all required dependencies. Test class member ordering and method length compliance.</ideas>
    <ideas ac="2">Test complete workflow sequence: validate → select type → generate → preview → action → commit. Mock each dependency and verify correct call order.</ideas>
    <ideas ac="3,6">Test error handling for UserError, SystemError, ValidationError with proper remediation. Test cancel handling at each interactive prompt with isCancel scenarios.</ideas>
    <ideas ac="4">Test UI component integration by mocking TypeSelector, MessagePreview, ActionSelector and verifying they are called with correct parameters.</ideas>
    <ideas ac="7">Test all workflow paths including success, each error type, cancel at each step, and editor workflow integration. Mock service methods and verify controller orchestrates correctly.</ideas>
  </tests>
</story-context>