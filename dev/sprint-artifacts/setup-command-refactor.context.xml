<story-context id="{bmad_folder}/bmm/workflows/chore/story-context/refactor-setup" v="1.0">
  <metadata>
    <epicId>ARCH</epicId>
    <storyId>1</storyId>
    <title>Refactor Setup Command to Hexagonal Architecture</title>
    <status>drafted</status>
    <generatedAt>2025-12-01</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>dev/sprint-artifacts/setup-command-refactor.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>system architect</asA>
    <iWant>to extract business logic from the SetupCommand into a dedicated ProvisionEnvironment use case</iWant>
    <soThat>the CLI layer is decoupled from business logic, adherence to Hexagonal Architecture is enforced, and testing logic is isolated from CLI implementation details</soThat>
    <tasks>Task 1: Extract ProvisionEnvironment Use Case (AC: #1, #2)
  - Subtask 1.1: Create src/features/setup/use-cases/provision-environment.ts
  - Subtask 1.2: Move private validation logic (daemon, base-model, custom-model) from command to use case
  - Subtask 1.3: Inject LlmPort and SetupUiPort into Use Case constructor
- Task 2: Migrate Logic Tests (AC: #3)
  - Subtask 2.1: Create src/features/setup/use-cases/provision-environment.test.ts
  - Subtask 2.2: Move logic-heavy tests (e.g., auto-pull, error handling) from setup-command.test.ts
  - Subtask 2.3: Refactor tests to target ProvisionEnvironment directly without mocking Commander
- Task 3: Simplify SetupCommand (AC: #4)
  - Subtask 3.1: Update SetupCommand constructor to accept ProvisionEnvironment instead of Ports
  - Subtask 3.2: Remove all private business logic methods from SetupCommand
  - Subtask 3.3: Update execute method to simply delegate to useCase.execute()
- Task 4: Application Wiring (AC: #5)
  - Subtask 4.1: Update main.ts to compose ProvisionEnvironment with adapters
  - Subtask 4.2: Update createSetupCommand factory to inject Use Case into Command</tasks>
  </story>

  <acceptanceCriteria>1. **Separation of Concerns** - SetupCommand must NOT contain any conditional business logic (no if statements checking model existence).
2. **Use Case Pattern** - All provisioning logic resides in `src/features/setup/use-cases/provision-environment.ts`.
3. **Test Isolation** - Business logic tests verify the Use Case directly; Command tests only verify wiring/registration.
4. **Thin Adapter** - SetupCommand serves purely as a Primary Adapter (Controller) triggering the Use Case.
5. **Behavior Parity** - The `ollatool setup` command behaves exactly as before from the user's perspective.</acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>dev/architecture.md</path>
        <title>Hexagonal Architecture Principles</title>
        <section>Primary Adapters vs Application Logic</section>
        <snippet>Primary Adapters (Commands/Controllers) drive the application but contain no business rules. Application Logic (Use Cases) orchestrates domain objects and ports.</snippet>
      </doc>
      <doc>
        <path>src/features/commit/use-cases/validate-preconditions.ts</path>
        <title>Existing Use Case Pattern</title>
        <section>Reference Pattern</section>
        <snippet>Example of a clean Use Case in the features directory. It orchestrates Ports (GitPort, LlmPort) and returns a result, throwing typed errors on failure.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>src/features/setup/setup-command.ts</path>
        <kind>source</kind>
        <symbol>SetupCommand</symbol>
        <lines>14-244</lines>
        <reason>Current "God Class" implementation to be refactored. Contains mixed concerns of CLI registration and Provisioning logic.</reason>
      </artifact>
      <artifact>
        <path>src/features/setup/setup-command.test.ts</path>
        <kind>test</kind>
        <symbol>SetupCommand Tests</symbol>
        <lines>1-365</lines>
        <reason>Existing tests to be split. "Daemon Validation" and "Base Model Auto-Pull" logic tests move to use-case test file.</reason>
      </artifact>
      <artifact>
        <path>src/main.ts</path>
        <kind>source</kind>
        <symbol>createSetupCommand</symbol>
        <lines>19-33</lines>
        <reason>Dependency Injection root. Needs update to instantiate ProvisionEnvironment before SetupCommand.</reason>
      </artifact>
    </code>
    <dependencies>
      <ecosystem name="node">
        <packages>
          <package name="commander" version="12.1.0" reason="Used only in SetupCommand (Adapter layer), NOT in Use Case"/>
        </packages>
      </ecosystem>
      <ecosystem name="vitest">
        <packages>
          <package name="vitest" version="4.0.14" reason="Testing framework for both unit (logic) and integration (wiring) tests"/>
        </packages>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint name="Hexagonal Purity" source="dev/architecture.md">
      The Use Case (ProvisionEnvironment) must NOT import 'commander' or know about CLI arguments. It only accepts OllamaModelConfig.
    </constraint>
    <constraint name="Use Case Location" source="Architectural Pattern">
      Use Cases must be located in `src/features/<feature-name>/use-cases/` to align with the existing Commit feature structure.
    </constraint>
    <constraint name="Dependency Injection" source="dev/architecture.md">
      Dependencies (LlmPort, SetupUiPort) must be injected into the Use Case via constructor, not instantiated inside.
    </constraint>
    <constraint name="Error Handling" source="src/core/types/errors.types.ts">
      The Use Case must throw typed AppErrors (SystemError, UserError) which the Command or Main loop catches.
    </constraint>
    <constraint name="Function Size" source="Clean Code Standards">
      Private methods extracted to the Use Case must adhere to the 15-line limit where possible.
    </constraint>
  </constraints>

  <interfaces>
    <interface name="LlmPort" source="src/core/ports/llm-port.ts" reason="Dependency">
      Core port required by ProvisionEnvironment to check connection, check models, and pull/create models.
    </interface>
    <interface name="SetupUiPort" source="src/core/ports/setup-ui-port.ts" reason="Dependency">
      Core port required by ProvisionEnvironment to handle spinner states and user feedback.
    </interface>
    <interface name="OllamaModelConfig" source="src/core/types/llm-types.ts" reason="Input DTO">
      Configuration object passed to the execute method of the Use Case.
    </interface>
  </interfaces>

  <tests>
    <standards>Follow the pattern established in validate-preconditions.test.ts. Use Case tests should mock Ports directly. Command tests should verify that the Use Case execute method is called with correct config.</standards>
    <locations>src/features/setup/use-cases/provision-environment.test.ts (Logic), src/features/setup/setup-command.test.ts (Wiring)</locations>
    <ideas>
      <testIdea acId="2" description="ProvisionEnvironment executes validation steps in correct order (Daemon -> Base Model -> Custom Model)"/>
      <testIdea acId="2" description="ProvisionEnvironment throws SystemError immediately if Daemon check fails"/>
      <testIdea acId="2" description="ProvisionEnvironment triggers auto-pull loop if base model is missing"/>
      <testIdea acId="4" description="SetupCommand.register calls program.command('setup') and correctly maps action to useCase.execute"/>
    </ideas>
  </tests>
</story-context>